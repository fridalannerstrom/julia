{% load static %}
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Julia ‚Äì Chatt</title>

  <!-- Bootstrap CSS (samma som index) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Dina egna styles -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" href="{% static 'img/favicon.ico' %}">

  <!-- Markdown-rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Chat-bubblor, anpassat till admin-layouten */
    #chat-wrap{
      height:60vh;
      overflow-y:auto;
      border:1px solid #eef1f5;
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .msg{margin:10px 0; display:flex; gap:8px}
    .bubble{
      padding:10px 12px;
      border-radius:10px;
      max-width:75%;
      white-space:pre-wrap;
    }
    .bubble-user{
      margin-left:auto;
      background:#e8f0ff;
    }
    .bubble-ai{
      margin-right:auto;
      background:#f2f5f9;
    }
    .meta{
      font-size:.8rem;
      color:#6b7280;
      margin-bottom:4px;
    }
    .typing{
      opacity:.7;
      font-style:italic;
    }
  </style>
</head>

<body id="page-top">
  <div class="app-shell">

    <!-- SIDEBAR (samma som index, men Chatt aktiv) -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <span class="brand-dot"></span>
        <span class="brand-text">Julia AI</span>
      </div>

      <nav class="sidebar-nav">
        <a href="{% url 'index' %}" class="sidebar-link">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span>Skapa rapport</span>
        </a>
        <a href="{% url 'report_list' %}" class="sidebar-link">
          <span class="sidebar-icon">üí¨</span>
          <span>Sparade rapporter</span>
        </a>
        <a href="{% url 'prompt_editor' %}" class="sidebar-link">
          <span class="sidebar-icon">üìù</span>
          <span>√Ñndra prompts</span>
        </a>
        <a href="{% url 'chat_home' %}" class="sidebar-link sidebar-link-active">
          <span class="sidebar-icon">üí¨</span>
          <span>Chatt</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-chip">
          <div class="user-avatar">
            {{ user.first_name|default:"J" |first }}
          </div>
          <div class="user-meta">
            <span>Inloggad som</span>
            <strong>{{ user.get_full_name|default:"G√§st" }}</strong>
          </div>
        </div>
        <button class="logout-btn" type="button">
          Logga ut
        </button>
        <p class="sidebar-copy">¬© TQ Nordic</p>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-area">
      <header class="page-header">
        <div>
          <h1>{{ session.title|default:"Chatt" }} üí¨</h1>
          <p>Forts√§tt dialogen med Julia AI, justera inst√§llningar och ladda upp filer.</p>
        </div>
        <div class="page-header-meta">
          <span class="pill">Domarn√§mnden</span>
          <span class="pill pill-soft">Chatt-session</span>
        </div>
      </header>

      <section id="chat-session">
        <div class="adminui-layout">
          <div class="adminui-main">
            <div class="adminui-container">

              <div class="row g-3">
                <!-- V√§nster kolumn: inst√§llningar + lista √∂ver chattar -->
                <div class="col-12 col-md-4">
                  <div class="adminui-container" style="margin-bottom:16px;">
                    <h3 class="adminui-subtitle">Inst√§llningar</h3>
                    <form method="post" class="mb-2">
                      {% csrf_token %}
                      <div class="mb-2">
                        <label class="form-label">Titel</label>
                        <input name="title" class="form-control" value="{{ session.title }}">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Instruktion (system-prompt)</label>
                        <textarea name="system_prompt" rows="3" class="form-control">{{ session.system_prompt }}</textarea>
                      </div>
                      <button name="save_settings" value="1" class="adminui-button">
                        üíæ Spara
                      </button>
                    </form>
                  </div>

                  <div class="adminui-container">
                    <h3 class="adminui-subtitle">Dina chattar</h3>
                    <div class="card p-0">
                      <div class="list-group list-group-flush">

                        {% for s in sessions %}
                          <div class="list-group-item d-flex align-items-center gap-2">
                            <a class="flex-grow-1 text-decoration-none {% if s.id == session.id %}fw-semibold{% endif %}"
                               href="{% url 'chat_session' s.id %}">
                              {{ s.title }}
                            </a>

                            <small class="text-muted me-2">
                              {{ s.updated_at|date:"M j, Y, H:i" }}
                            </small>

                            <form action="{% url 'chat_delete' s.id %}" method="post"
                                  onsubmit="return confirm('Ta bort denna chatt? Det g√•r inte att √•ngra.');">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-sm btn-outline-danger" title="Ta bort">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     viewBox="0 0 16 16" aria-hidden="true">
                                  <path d="M5.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0V6z"/>
                                  <path fill-rule="evenodd"
                                        d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2H5h6h2.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM5 2.5a.5.5 0 0 0 .5.5h5a.5.5 0 0 0 .5-.5V2H5v.5z"/>
                                </svg>
                              </button>
                            </form>
                          </div>
                        {% empty %}
                          <div class="list-group-item text-muted">Ingen historik √§nnu.</div>
                        {% endfor %}

                      </div>
                    </div>
                  </div>
                </div>

                <!-- H√∂ger kolumn: sj√§lva chatten -->
                <div class="col-12 col-md-8">
                  <div class="adminui-container" style="margin-bottom:16px;">
                    <h3 class="adminui-subtitle">Konversation</h3>

                    <div id="chat-wrap" class="card p-3 mb-3">
                      {% for m in messages %}
                        <div class="msg">
                          <div class="w-100">
                            <div class="meta">{{ m.role|title }} ‚Ä¢ {{ m.created_at }}</div>

                            {% if m.role == "user" %}
                              <div class="bubble bubble-user">{{ m.content }}</div>
                            {% else %}
                              <!-- L√•t JS rendera Markdown ‚Üí HTML f√∂r historiken ocks√• -->
                              <div class="bubble bubble-ai" data-md="{{ m.content|escape }}"></div>
                            {% endif %}

                            {% if m.attachments.all %}
                              <div class="mt-2">
                                {% for a in m.attachments.all %}
                                  <a href="{{ a.file.url }}" target="_blank">üìé {{ a.original_name }}</a><br>
                                {% endfor %}
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      {% empty %}
                        <p class="text-muted">Ingen historik √§nnu.</p>
                      {% endfor %}
                    </div>

                    <!-- Composer -->
                    <div class="card p-3">
                      <form id="chat-form" action="{% url 'chat_send' session.id %}"
                            method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-2">
                          <label class="form-label">Meddelande</label>
                          <textarea name="message" id="msg" rows="3" class="form-control"
                                    placeholder="Skriv ett meddelande‚Ä¶"></textarea>
                        </div>
                        <div class="mb-2">
                          <label class="form-label">Filer (valfritt)</label>
                          <input type="file" name="files" id="files" multiple class="form-control">
                        </div>
                        <button type="submit" class="adminui-button">Skicka</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

            </div> <!-- /adminui-container -->
          </div>   <!-- /adminui-main -->
        </div>     <!-- /adminui-layout -->
      </section>
    </main>

    <!-- H√ñGERSPALT -->
    <aside class="right-panel">
      <h3 class="assistant-title">Tips f√∂r bra fr√•gor</h3>
      <p class="assistant-help adminui-intro">
        Ju mer konkret du √§r i dina fr√•gor, desto mer pricks√§kra svar kan Julia AI ge.
        Koppla g√§rna dina fr√•gor till testdata, intervjun eller bed√∂mningarna.
      </p>

      <h3 class="assistant-title">Exempel</h3>
      <div class="tag-box">
        <div class="tag-box-left">
          <p><strong>Exempel 1</strong></p>
          <p>‚ÄúUtifr√•n denna kandidats resultat och mina anteckningar, vilka tv√• risker b√∂r jag
          vara extra uppm√§rksam p√•?‚Äù</p>
        </div>
      </div>

      <div class="tag-box">
        <div class="tag-box-left">
          <p><strong>Exempel 2</strong></p>
          <p>‚ÄúFormulera ett avsnitt om kandidatens styrkor i ledarskap i samma stil som rapporten.‚Äù</p>
        </div>
      </div>
    </aside>

  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/script.js' %}"></script>

<script>
(function () {
  const wrap = document.getElementById('chat-wrap');
  const form = document.getElementById('chat-form');
  const msgEl = document.getElementById('msg');
  const filesEl = document.getElementById('files');

  // Rendera historiska AI-meddelanden (Markdown -> HTML)
  document.querySelectorAll('.bubble-ai[data-md]').forEach(el => {
    const raw = el.getAttribute('data-md') || '';
    el.innerHTML = marked.parse(raw);
    el.removeAttribute('data-md');
  });

  function scrollBottom() {
    if (wrap) {
      wrap.scrollTop = wrap.scrollHeight;
    }
  }
  scrollBottom();

  if (!form || !wrap) return;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1) Visa user-bubbla direkt
    const userText = msgEl.value.trim();
    const userMsg = document.createElement('div');
    userMsg.className = 'msg';
    userMsg.innerHTML = `
      <div class="w-100">
        <div class="meta">User ‚Ä¢ nu</div>
        <div class="bubble bubble-user"></div>
        <div class="user-attachments mt-2 small"></div>
      </div>`;
    userMsg.querySelector('.bubble-user').textContent = userText || '(fil skickad)';
    wrap.appendChild(userMsg);

    // 2) F√∂rbered AI-bubbla (stream-m√•l)
    const aiMsg = document.createElement('div');
    aiMsg.className = 'msg';
    aiMsg.innerHTML = `
      <div class="w-100">
        <div class="meta">Assistant ‚Ä¢ skriver‚Ä¶</div>
        <div class="bubble bubble-ai"><span class="typing">Skriver‚Ä¶</span></div>
      </div>`;
    const aiBubble = aiMsg.querySelector('.bubble-ai');
    wrap.appendChild(aiMsg);
    scrollBottom();

    // 3) Skicka stream-POST
    const fd = new FormData(form);  // inkluderar CSRF + filer
    msgEl.value = '';
    filesEl.value = '';

    try {
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      if (!resp.ok || !resp.body) {
        aiBubble.textContent = '(Fel: kunde inte starta streamen)';
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder('utf-8');

      let raw = '';
      let controlDone = false;
      let controlBuf = '';

      aiBubble.innerHTML = ''; // ta bort "skriver‚Ä¶"

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });

        if (!controlDone) {
          controlBuf += chunk;
          const nlIdx = controlBuf.indexOf('\n');

          if (nlIdx !== -1) {
            const firstLine = controlBuf.slice(0, nlIdx);
            const rest = controlBuf.slice(nlIdx + 1);

            if (firstLine.startsWith('__ATTACH_JSON__')) {
              try {
                const jsonStr = firstLine.replace('__ATTACH_JSON__', '');
                const links = JSON.parse(jsonStr || '[]');
                if (Array.isArray(links) && links.length) {
                  const holder = userMsg.querySelector('.user-attachments');
                  holder.innerHTML = links.map(l =>
                    `üîó <a href="${l.url}" target="_blank" rel="noopener">Bifogad fil: ${l.name}</a>`
                  ).join('<br>');
                }
              } catch (e) {
                // ignorera parsningfel
              }
            }

            controlDone = true;

            if (rest) {
              raw += rest;
              aiBubble.innerHTML = marked.parse(raw);
              scrollBottom();
            }
          }
          continue;
        }

        // Vanlig AI-text efter kontrollraden
        raw += chunk;
        aiBubble.innerHTML = marked.parse(raw);
        scrollBottom();
      }

      aiMsg.querySelector('.meta').textContent = 'Assistant ‚Ä¢ nu';
      scrollBottom();

    } catch (err) {
      aiBubble.textContent = '(Ett fel intr√§ffade: ' + err + ')';
      scrollBottom();
    }
  });
})();
</script>

</body>
</html>
