{% load static %}
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chatt â€“ session</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{background:#f7f9fc}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .sidebar{max-height:80vh;overflow:auto}

    /* Chat */
    #chat-wrap{height:60vh; overflow-y:auto; border:1px solid #eef1f5; border-radius:12px; padding:12px}
    .msg{margin:10px 0; display:flex; gap:8px}
    .bubble{padding:10px 12px; border-radius:10px; max-width:75%; white-space:pre-wrap}
    .bubble-user{margin-left:auto; background:#e8f0ff}
    .bubble-ai{margin-right:auto; background:#f2f5f9}
    .meta{font-size:.8rem; color:#6b7280; margin-bottom:4px}
    .typing{opacity:.7; font-style:italic}
  </style>

  <!-- Markdown-rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'index' %}">Julia AI</a>
    <div class="d-flex gap-3">
      <a class="nav-link text-white-50" href="{% url 'index' %}">Verktyget</a>
      <a class="nav-link text-white-50" href="{% url 'prompt_editor' %}">Ã„ndra prompts</a>
      <a class="nav-link text-white" href="{% url 'chat_home' %}">Chatt</a>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="row g-3">
    <!-- Sidebar -->
    <div class="col-12 col-md-4">
      <div class="card p-3 mb-3">
        <form method="post" class="mb-2">
          {% csrf_token %}
          <h5 class="mb-3">InstÃ¤llningar</h5>
          <div class="mb-2">
            <label class="form-label">Titel</label>
            <input name="title" class="form-control" value="{{ session.title }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Instruktion (system-prompt)</label>
            <textarea name="system_prompt" rows="3" class="form-control">{{ session.system_prompt }}</textarea>
          </div>
          <button name="save_settings" value="1" class="btn btn-outline-primary">Spara</button>
        </form>
      </div>

      <div class="card p-0 sidebar">
        <div class="list-group list-group-flush">
          {% for s in sessions %}
            <a class="list-group-item list-group-item-action {% if s.id == session.id %}active{% endif %}"
               href="{% url 'chat_session' s.id %}">
              {{ s.title }}
            </a>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Main chat -->
    <div class="col-12 col-md-8">
      <div id="chat-wrap" class="card p-3 mb-3">
        {% for m in messages %}
          <div class="msg">
            <div class="w-100">
              <div class="meta">{{ m.role|title }} â€¢ {{ m.created_at }}</div>

              {% if m.role == "user" %}
                <div class="bubble bubble-user">{{ m.content }}</div>
              {% else %}
                <!-- LÃ¥t JS rendera Markdown â†’ HTML fÃ¶r historiken ocksÃ¥ -->
                <div class="bubble bubble-ai" data-md="{{ m.content|escape }}"></div>
              {% endif %}

              {% if m.attachments.all %}
                <div class="mt-2">
                  {% for a in m.attachments.all %}
                    <a href="{{ a.file.url }}" target="_blank">ðŸ“Ž {{ a.original_name }}</a><br>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p class="text-muted">Ingen historik Ã¤nnu.</p>
        {% endfor %}
      </div>

      <!-- Composer -->
      <div class="card p-3">
        <form id="chat-form" action="{% url 'chat_send' session.id %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Meddelande</label>
            <textarea name="message" id="msg" rows="3" class="form-control" placeholder="Skriv ett meddelandeâ€¦"></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Filer (valfritt)</label>
            <input type="file" name="files" id="files" multiple class="form-control">
          </div>
          <button type="submit" class="btn btn-primary">Skicka</button>
        </form>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const wrap = document.getElementById('chat-wrap');
  const form = document.getElementById('chat-form');
  const msgEl = document.getElementById('msg');
  const filesEl = document.getElementById('files');

  // Rendera historiska AI-meddelanden (Markdown -> HTML)
  document.querySelectorAll('.bubble-ai[data-md]').forEach(el => {
    const raw = el.getAttribute('data-md') || '';
    el.innerHTML = marked.parse(raw);
    el.removeAttribute('data-md');
  });

  function scrollBottom(){ wrap.scrollTop = wrap.scrollHeight; }
  scrollBottom();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1) Visa user-bubbla direkt
    const userText = msgEl.value.trim();
    const userMsg = document.createElement('div');
    userMsg.className = 'msg';
    userMsg.innerHTML = `
      <div class="w-100">
        <div class="meta">User â€¢ nu</div>
        <div class="bubble bubble-user"></div>
        <div class="user-attachments mt-2 small"></div> <!-- hÃ¤r kommer lÃ¤nkarna -->
      </div>`;
    userMsg.querySelector('.bubble-user').textContent = userText || '(fil skickad)';
    wrap.appendChild(userMsg);

    // 2) FÃ¶rbered AI-bubbla (stream-mÃ¥l)
    const aiMsg = document.createElement('div');
    aiMsg.className = 'msg';
    aiMsg.innerHTML = `
      <div class="w-100">
        <div class="meta">Assistant â€¢ skriverâ€¦</div>
        <div class="bubble bubble-ai"><span class="typing">Skriverâ€¦</span></div>
      </div>`;
    const aiBubble = aiMsg.querySelector('.bubble-ai');
    wrap.appendChild(aiMsg);
    scrollBottom();

    // 3) Skicka stream-POST
    const fd = new FormData(form);           // inkluderar CSRF + filer
    msgEl.value = ''; filesEl.value = '';

    try {
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      if (!resp.ok || !resp.body) {
        aiBubble.textContent = '(Fel: kunde inte starta streamen)';
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder('utf-8');

      let raw = '';
      let controlDone = false;
      let controlBuf = '';

      aiBubble.innerHTML = ''; // ta bort "skriverâ€¦"

      while (true) {
        const {value, done} = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, {stream:true});

        if (!controlDone) {
          controlBuf += chunk;
          const nlIdx = controlBuf.indexOf('\n');
          if (nlIdx !== -1) {
            const firstLine = controlBuf.slice(0, nlIdx);
            let rest = controlBuf.slice(nlIdx + 1);

            if (firstLine.startsWith('__ATTACH_JSON__')) {
              try {
                const jsonStr = firstLine.replace('__ATTACH_JSON__','');
                const links = JSON.parse(jsonStr || '[]');
                if (Array.isArray(links) && links.length) {
                  const holder = userMsg.querySelector('.user-attachments');
                  holder.innerHTML = links.map(l =>
                    `ðŸ”— <a href="${l.url}" target="_blank" rel="noopener">Bifogad fil: ${l.name}</a>`
                  ).join('<br>');
                }
              } catch(e) {
                // ignorera parsningfel
              }
            }
            controlDone = true;

            // resten av chunken Ã¤r del av AI-texten
            if (rest) {
              raw += rest;
              aiBubble.innerHTML = marked.parse(raw);
              scrollBottom();
            }
          }
          continue; // invÃ¤nta att vi fÃ¥tt fÃ¶rsta hela raden
        }

        // Vanlig AI-text efter kontrollraden
        raw += chunk;
        aiBubble.innerHTML = marked.parse(raw);
        scrollBottom();
      }

      aiMsg.querySelector('.meta').textContent = 'Assistant â€¢ nu';
      scrollBottom();

    } catch (err) {
      aiBubble.textContent = `(Ett fel intrÃ¤ffade: ${err})`;
      scrollBottom();
    }
  });
})();
</script>
</body>
</html>
