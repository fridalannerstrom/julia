{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Julia ‚Äì Rapport</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Din egna styles -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <!-- Beh√∂vs om du vill visa rating-tabellerna snyggt (och om de ligger som HTML i datan) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
.export-preview {
  width: 100%;
  max-width: 520px;   /* üî• justera detta */
  height: auto;
}

/* Bara n√§r vi exporterar till bild */
.export-scale {
  font-size: 14px !important; /* testa 13px/12px om du vill mindre */
  line-height: 1.35 !important;
}

/* Om din tabell har rubriker som sticker iv√§g */
.export-scale h1,
.export-scale h2,
.export-scale h3,
.export-scale .dn-title,
.export-scale .dn-table-title {
  font-size: 18px !important; /* testa 16px */
  line-height: 1.2 !important;
}

/* Om du har ‚Äúlabel‚Äù-texter */
.export-scale .dn-label {
  font-size: 14px !important;
}

</style>


</head>

<body id="page-top">
  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <span class="brand-dot"></span>
        <span class="brand-text">Julia AI</span>
      </div>

      <nav class="sidebar-nav">
        <a href="{% url 'index' %}" class="sidebar-link sidebar-link-active">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span>Skapa rapport</span>
        </a>
        <a href="{% url 'report_list' %}" class="sidebar-link">
          <span class="sidebar-icon">üí¨</span>
          <span>Sparade rapporter</span>
        </a>
        <a href="{% url 'report_list' %}" class="sidebar-link sidebar-link-active">
          <span class="sidebar-icon">üìÑ</span>
          <span>Rapporter</span>
        </a>

        <a href="{% url 'prompt_editor' %}" class="sidebar-link">
          <span class="sidebar-icon">üìù</span>
          <span>√Ñndra prompts</span>
        </a>

        <a href="{% url 'chat_home' %}" class="sidebar-link">
          <span class="sidebar-icon">üí¨</span>
          <span>Chatt</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-chip">
          <div class="user-avatar">
            {{ user.first_name|default:"J"|first }}
          </div>
          <div class="user-meta">
            <span>Inloggad som</span>
            <strong>{{ user.first_name|default:user.username }} {{ user.last_name }}</strong>
          </div>
        </div>
        <button class="logout-btn" type="button">Logga ut</button>
        <p class="sidebar-copy">¬© TQ Nordic</p>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-area">
      <header class="page-header">
        <div>
          <h1>Rapport</h1>
          <p>
            {% if report.updated_at %}
              Uppdaterad {{ report.updated_at|date:"Y-m-d H:i" }}
            {% endif %}
          </p>
        </div>

        <div class="page-header-meta">
          <a class="pill pill-soft" href="{% url 'report_edit' report.id %}">‚úèÔ∏è Redigera</a>
<!-- ‚úÖ DOWNLOAD WORD (POST) -->
<form id="downloadWordForm" method="POST" action="{% url 'report_download' report.id %}">
  {% csrf_token %}

  <!-- Hidden inputs som JS fyller med PNG-dataURL -->
  <input type="hidden" name="leda_image" id="leda_image_input">
  <input type="hidden" name="mod_image" id="mod_image_input">
  <input type="hidden" name="sjalkannedom_image" id="sjalkannedom_image_input">
  <input type="hidden" name="strategi_image" id="strategi_image_input">
  <input type="hidden" name="kommunikation_image" id="kommunikation_image_input">

  <button type="submit" class="pill" id="downloadWordBtn" disabled>
    üìÑ Ladda ner Word
  </button>
</form>

</form>
        </div>
      </header>

      <section class="adminui-layout">
        <div class="adminui-main">
          <div class="adminui-container">

            <div class="dn-report">

              <!-- HEADER-BANNER (logga / gradient) -->
              <div class="dn-report-header">
                <img src="{% static 'jurek_logo.png' %}" alt="Logotyp" class="dn-report-logo">
              </div>

              <div class="dn-report-body">

                {# RAD 0 ‚Äì Namn #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <h5 class="dn-subheading">{{ data.candidate_name }}</h5>
                  </div>
                  <div class="dn-report-col dn-report-col--right">
                    {% if data.candidate_role %}
                      <h5 class="dn-body-text">{{ data.candidate_role }}</h5>
                    {% endif %}
                  </div>
                </div>

                {# RAD 1 ‚Äì Intro + Po√§ngskala #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <p class="dn-body-text">
                      Alla har beteendepreferenser p√• arbetet som p√•verkar v√•rt agerande.
                      En individs preferenser p√•verkar, men dikterar inte individens beteende.
                      Det √§r m√∂jligt att arbeta utanf√∂r v√•ra naturliga preferenser, men det
                      kr√§ver sj√§lvk√§nnedom, en medveten insats och energi. Om en individs
                      f√∂redragna eller typiska beteende inte sammanfaller med kraven f√∂r en
                      s√§rskild roll, kan det inneb√§ra att individen upplever det som
                      utmanande och dr√§nerande att uppr√§tth√•lla prestation √∂ver tid.
                      <br><br>
                      Skalan visar hur sannolikt en kompetens √§r stark eller ej hos en individ.
                    </p>
                  </div>

                  <div class="dn-report-col dn-report-col--right">
                    <h5 class="dn-subheading">Po√§ngskala</h5>
                    <div class="dn-report-table dn-report-table--scale">
                      <table class="dn-table dn-table-scale">
                        <thead>
                          <tr>
                            <th class="dn-scale-head dn-scale-head--empty"></th>
                            <th class="dn-scale-head">Utrymme f√∂r<br>utveckling</th>
                            <th class="dn-scale-head">Tillr√§cklig</th>
                            <th class="dn-scale-head">God</th>
                            <th class="dn-scale-head">Mycket god</th>
                            <th class="dn-scale-head">Utm√§rkt</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td class="dn-scale-desc">
                              Kandidaten √§r sannolikt <strong>mycket mindre effektiv</strong> √§n de flesta
                              n√§r det g√§ller att visa denna kompetens p√• arbetet.
                            </td>
                            <td class="dn-cell"><span class="dn-scale-dot dn-scale-dot--active"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                          </tr>
                          <tr>
                            <td class="dn-scale-desc">
                              Kandidaten √§r sannolikt <strong>mindre effektiv</strong> √§n m√•nga n√§r det
                              g√§ller att visa denna kompetens p√• arbetet.
                            </td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot dn-scale-dot--active"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                          </tr>
                          <tr>
                            <td class="dn-scale-desc">
                              Kandidaten √§r sannolikt <strong>lika effektiv</strong> som de flesta
                              n√§r det g√§ller att visa denna kompetens p√• arbetet.
                            </td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot dn-scale-dot--active"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                          </tr>
                          <tr>
                            <td class="dn-scale-desc">
                              Kandidaten √§r sannolikt <strong>mer effektiv</strong> √§n m√•nga n√§r det
                              g√§ller att visa denna kompetens p√• arbetet.
                            </td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot dn-scale-dot--active"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                          </tr>
                          <tr>
                            <td class="dn-scale-desc">
                              Kandidaten √§r sannolikt <strong>mycket mer effektiv</strong> √§n de
                              flesta n√§r det g√§ller att visa denna kompetens p√• arbetet.
                            </td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot"></span></td>
                            <td class="dn-cell"><span class="dn-scale-dot dn-scale-dot--active"></span></td>
                          </tr>
                        </tbody>
                      </table>

                      <br>

                      <div class="dn-report-text">
                        Denna rapport bygger p√• TQ-testresultat och intervju. Fokus ligger p√• kandidatens typiska arbetss√§tt, styrkor, utvecklingsomr√•den och m√∂jliga riskbeteenden vid h√∂g press.
                        <br><br>
                        Resultaten beskriver beteendepreferenser, inte fastlagda sanningar om kandidaten som person. Kandidaten kan agera utanf√∂r sina naturliga m√∂nster, men det kr√§ver mer medveten anstr√§ngning och energi. Om arbetsrollen under l√•ng tid kr√§ver beteenden l√•ngt ifr√•n kandidatens preferenser finns en risk att det blir mer anstr√§ngande att bibeh√•lla samma niv√• av prestation.
                      </div>
                    </div>
                  </div>
                </div>

                {# RAD 2 ‚Äì TQ F√§rdighet #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <h4 class="dn-label">TQ F√§rdighet</h4>
                    <p class="dn-body-text">
                      Resultatet i dessa tester avg√∂rs av hur snabb och noggrann kandidaten i fr√•ga √§r.
                      Fr√•gorna √§r adaptiva vilket inneb√§r att sv√•righetsgraden √§ndras beroende p√• om man
                      svarar r√§tt eller fel.
                    </p>
                  </div>
                  <div class="dn-report-col dn-report-col--right">
                    <div class="dn-report-text">
                      {{ data.tq_fardighet_text|safe }}
                    </div>
                  </div>
                </div>

                {# RAD 3 ‚Äì Styrkor / Utvecklingsomr√•den / Risk #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <h4 class="dn-label">1. Styrkor<br>2. Utvecklingsomr√•den<br>3. Riskbeteenden</h4>
                  </div>
                  <div class="dn-report-col dn-report-col--right">
                    <div class="dn-report-text">
                      {{ data.sur_text|safe }}
                    </div>
                  </div>
                </div>

                {# RAD 4 ‚Äì Motivation #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <h4 class="dn-label">Definition av kandidatens<br>3 fr√§msta motivationsfaktorer</h4>

                    {% if data.selected_motivations %}
                      {% for mot in data.selected_motivations %}
                        <p class="dn-body-text">
                          <strong>{{ mot.label }}</strong> {{ mot.definition }}
                        </p>
                      {% endfor %}
                    {% else %}
                      <p class="dn-body-text">Inga motivationsfaktorer har valts i verktyget.</p>
                    {% endif %}
                  </div>

                  <div class="dn-report-col dn-report-col--right">
                    <div class="dn-report-text">
                      {{ data.tq_motivation_text|safe }}
                    </div>
                  </div>
                </div>

{# RAD 5 ‚Äì Leda #}
<div class="dn-report-row">
  <div class="dn-report-col dn-report-col--left">
    <h4 class="dn-label">Leda, utveckla och engagera</h4>
    <p class="dn-body-text">
      En chef ska kunna s√§tta upp och arbeta uth√•lligt mot tydliga m√•l som bidrar till
      verksamhetens resultat och utveckling, samt motivera och engagera medarbetarna.
    </p>
  </div>

  <div class="dn-report-col dn-report-col--right">
    <!-- 1) HTML-tabellen (renderas av Django) -->
    <div id="leda-export" class="rating-export">
      {{ leda_table_html|safe }}
    </div>

    <!-- 2) Preview-bild (fylls av JS) -->
    <img id="leda-preview" class="dn-report-table export-table" alt="Leda-tabell" />

    <!-- 3) Texten -->
    <div class="dn-report-text">
      {{ data.leda_text|safe }}
    </div>
  </div>
</div>


                {# RAD 6 ‚Äì Mod #}
 <div class="dn-report-row">
  <div class="dn-report-col dn-report-col--left">
    <h4 class="dn-label">Mod och handlingskraft</h4>
    <p class="dn-body-text">
      Att visa mod och handlingskraft inneb√§r att kunna ta ansvar och hantera sv√•ra
      situationer samt fatta beslut √§ven under press.
    </p>
  </div>

  <div class="dn-report-col dn-report-col--right">
    <div id="mod-export" class="rating-export">
      {{ mod_table_html|safe }}
    </div>

    <img
      id="mod-preview"
      class="dn-report-table export-preview"
      alt="Mod-tabell"
      style="display:none;"
    />

    <div class="dn-report-text">
      {{ data.mod_text|safe }}
    </div>
  </div>
</div>


                {# RAD 7 ‚Äì Sj√§lvk√§nnedom #}
                <div class="dn-report-row">
  <div class="dn-report-col dn-report-col--left">
    <h4 class="dn-label">Sj√§lvk√§nnedom och emotionell stabilitet</h4>
    <p class="dn-body-text">
      En chef beh√∂ver vara trygg, empatisk och medveten om sina egna styrkor och
      svagheter, samt kunna hantera stress i kr√§vande situationer.
    </p>
  </div>

  <div class="dn-report-col dn-report-col--right">
    <div id="sjalkannedom-export" class="rating-export">
      {{ sjalkannedom_table_html|safe }}
    </div>

    <img
      id="sjalkannedom-preview"
      class="dn-report-table export-preview"
      alt="Sj√§lvk√§nnedom-tabell"
      style="display:none;"
    />

    <div class="dn-report-text">
      {{ data.sjalkannedom_text|safe }}
    </div>
  </div>
</div>


                {# RAD 8 ‚Äì Strategi #}
 <div class="dn-report-row">
  <div class="dn-report-col dn-report-col--left">
    <h4 class="dn-label">Strategiskt t√§nkande och anpassningsf√∂rm√•ga</h4>
    <p class="dn-body-text">
      En chef ska kunna t√§nka strategiskt, v√§ga l√•ngsiktiga och kortsiktiga konsekvenser
      och anpassa sig efter f√∂r√§ndrade omst√§ndigheter.
    </p>
  </div>

  <div class="dn-report-col dn-report-col--right">
    <div id="strategi-export" class="rating-export">
      {{ strategi_table_html|safe }}
    </div>

    <img
      id="strategi-preview"
      class="dn-report-table export-preview"
      alt="Strategi-tabell"
      style="display:none;"
    />

    <div class="dn-report-text">
      {{ data.strategi_text|safe }}
    </div>
  </div>
</div>

                {# RAD 9 ‚Äì Kommunikation #}
<div class="dn-report-row">
  <div class="dn-report-col dn-report-col--left">
    <h4 class="dn-label">Kommunikation och samarbete</h4>
    <p class="dn-body-text">
      Som chef √§r det viktigt att kommunicera tydligt, vara lyh√∂rd och aktivt skapa
      samarbeten och relationer, b√•de internt och externt.
    </p>
  </div>

  <div class="dn-report-col dn-report-col--right">
    <div id="kommunikation-export" class="rating-export">
      {{ kommunikation_table_html|safe }}
    </div>

    <img
      id="kommunikation-preview"
      class="dn-report-table export-preview"
      alt="Kommunikation-tabell"
      style="display:none;"
    />

    <div class="dn-report-text">
      {{ data.kommunikation_text|safe }}
    </div>
  </div>
</div>


                {# RAD 10 ‚Äì Slutsats #}
                <div class="dn-report-row">
                  <div class="dn-report-col dn-report-col--left">
                    <h4 class="dn-label">Sammanfattande slutsats</h4>
                  </div>
                  <div class="dn-report-col dn-report-col--right">
                    <div class="dn-report-text">
                      {{ data.slutsats_text|safe }}
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

      </section>
    </main>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


<script>
(function () {
  // Map: export-div -> preview-img -> hidden input
  const TABLES = [
    { exportId: "leda-export",          previewId: "leda-preview",          inputId: "leda_image_input" },
    { exportId: "mod-export",           previewId: "mod-preview",           inputId: "mod_image_input" },
    { exportId: "sjalkannedom-export",  previewId: "sjalkannedom-preview",  inputId: "sjalkannedom_image_input" },
    { exportId: "strategi-export",      previewId: "strategi-preview",      inputId: "strategi_image_input" },
    { exportId: "kommunikation-export", previewId: "kommunikation-preview", inputId: "kommunikation_image_input" },
  ];

  const downloadBtn = document.getElementById("downloadWordBtn");
  const statusEl = document.getElementById("imgStatus");

  function setStatus(text) {
    if (statusEl) statusEl.textContent = text;
  }

  // Rendera EN div till PNG dataURL
async function renderToPngDataUrl(el) {
  // Skapa en offscreen wrapper
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.left = "-99999px";
  wrapper.style.top = "0";
  wrapper.style.width = el.offsetWidth + "px";
  wrapper.style.background = "#ffffff";
  wrapper.style.zIndex = "-1";

  // Klona export-elementet
  const clone = el.cloneNode(true);

  // L√§gg p√• export-klass (h√§r styr vi font-size)
  clone.classList.add("export-scale");

  // Viktigt: se till att klonen inte r√•kar bli bredare √§n wrappern
  clone.style.width = "100%";
  clone.style.maxWidth = "100%";
  clone.style.background = "#ffffff";

    const canvas = await html2canvas(el, {
      backgroundColor: "#ffffff",
      scale: 2,              // skarpare i Word
      useCORS: true,
      logging: false,
    });

    

    return canvas.toDataURL("image/png");
  }

  async function buildAllImages() {
    downloadBtn.disabled = true;
    setStatus("Skapar tabellbilder...");

    let okCount = 0;

    for (const t of TABLES) {
      const exportEl = document.getElementById(t.exportId);
      const previewEl = document.getElementById(t.previewId);
      const inputEl = document.getElementById(t.inputId);

      // Om sektion saknas i rapporten: hoppa
      if (!exportEl || !previewEl || !inputEl) continue;

      // Om tabellen √§r tom, hoppa
      const hasDots = exportEl.querySelector(".dn-dot");
      if (!hasDots) continue;

      try {
        // G√∂r PNG
        const dataUrl = await renderToPngDataUrl(exportEl);

        // S√§tt preview
        previewEl.src = dataUrl;
        previewEl.style.display = "block";
        previewEl.style.width = "100%";
previewEl.style.maxWidth = "100%";
previewEl.style.height = "auto";


        // S√§tt hidden input som skickas vid POST
        inputEl.value = dataUrl;

        // (Valfritt) g√∂m HTML-tabellen n√§r bilden finns
        exportEl.style.display = "none";

        okCount++;
      } catch (e) {
        console.error("Kunde inte skapa bild f√∂r", t.exportId, e);
      }
    }

    if (okCount > 0) {
      setStatus("Tabellbilder klara ‚úÖ");
      downloadBtn.disabled = false;
    } else {
      setStatus("Kunde inte skapa tabellbilder. Kontrollera att tabellerna renderas.");
      // L√•t knappen vara disabled s√• du inte laddar ner utan bilder
      downloadBtn.disabled = true;
    }
  }

  // K√∂r n√§r sidan √§r redo
  window.addEventListener("load", buildAllImages);
})();
</script>

</body>


</html>
