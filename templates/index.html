{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>Julia</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Din egna styles (ligger efter s√• den vinner) -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/trumbowyg.min.css">

  <link rel="icon" href="{% static 'img/favicon.ico' %}">

  <style>
    /* LOADING OVERLAY ‚Äì bara detta lokalt */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(17, 24, 39, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-box {
      background: #fff;
      padding: 22px 30px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-width: 200px;
      text-align: center;
    }

    .loading-spinner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top-color: #7b2cbf;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #loading-overlay p {
      font-size: 1rem;
      color: #111827;
      margin: 0;
      font-weight: 500;
    }
  </style>
</head>

<body id="page-top">
  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <span class="brand-dot"></span>
        <span class="brand-text">Julia AI</span>
      </div>

      <nav class="sidebar-nav">
        <a href="{% url 'index' %}" class="sidebar-link sidebar-link-active">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span>Verktyget</span>
        </a>
        <a href="{% url 'prompt_editor' %}" class="sidebar-link">
          <span class="sidebar-icon">üìù</span>
          <span>√Ñndra prompts</span>
        </a>
        <a href="{% url 'chat_home' %}" class="sidebar-link">
          <span class="sidebar-icon">üí¨</span>
          <span>Chatt</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-chip">
          <div class="user-avatar">
            {{ user.first_name|default:"J" |first }}
          </div>
          <div class="user-meta">
            <span>Inloggad som</span>
            <strong>{{ user.first_name|default:user.username }} {{ user.last_name }}</strong>
          </div>
        </div>
        <button class="logout-btn" type="button">
          Logga ut
        </button>
        <p class="sidebar-copy">¬© TQ Nordic</p>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-area">
      <header class="page-header">
        <div>
          <h1>Hej {{ user.first_name|default:user.username }} üëã</h1>
          <p>Kom ig√•ng med din rapport f√∂r Domarn√§mnden.</p>
        </div>
        <div class="page-header-meta">
          <span class="pill">Domarn√§mnden</span>
          <span class="pill pill-soft">Steg {{ step }} / 10</span>
        </div>
      </header>

      <section id="about">
        {% if error %}
        <div class="adminui-alert">
          {{ error }}
        </div>
        {% endif %}

        <div class="adminui-layout">
          <div class="adminui-main">
            <div class="adminui-container">

              <!-- Progressbar -->
              <div class="adminui-progress" style="--current-step: {{ step }}; --total-steps: 10;">
                <div class="adminui-progress-bar"></div>
              </div>

              <form method="post" enctype="multipart/form-data" class="adminui-form">
                {% csrf_token %}

                <!-- HIDDEN STATE -->
                <input type="hidden" name="step" value="{{ step }}">
                <input type="hidden" name="test_text" value="{{ test_text|escape }}">
                <input type="hidden" name="uploaded_files_markdown"
                       value="{{ uploaded_files_markdown|default_if_none:''|escape }}">

                <!-- NYTT: se till att cv_text finns kvar mellan steg -->
                <input type="hidden" name="cv_text" value="{{ cv_text|default_if_none:''|escape }}">

                <!-- Separata f√§lt f√∂r f√∂r- och efternamn -->
                <input type="hidden" name="candidate_first_name" value="{{ candidate_first_name }}">
                <input type="hidden" name="candidate_last_name" value="{{ candidate_last_name }}">

                <!-- Fullst√§ndigt namn f√∂r bak√•tkompatibilitet / JS -->
                <input type="hidden" name="candidate_name"
                       value="{{ candidate_first_name }} {{ candidate_last_name }}">

                <input type="hidden" name="candidate_role" value="{{ candidate_role }}">
                <input type="hidden" name="intervju_text" value="{{ intervju_text|escape }}">
                <input type="hidden" name="tq_fardighet_text" value="{{ tq_fardighet_text|escape }}">
                <input type="hidden" name="tq_motivation_text" value="{{ tq_motivation_text|escape }}">
                <input type="hidden" name="leda_text" value="{{ leda_text|escape }}">
                <input type="hidden" name="mod_text" value="{{ mod_text|escape }}">
                <input type="hidden" name="sjalkannedom_text" value="{{ sjalkannedom_text|escape }}">
                <input type="hidden" name="strategi_text" value="{{ strategi_text|escape }}">
                <input type="hidden" name="kommunikation_text" value="{{ kommunikation_text|escape }}">
                <input type="hidden" name="sur_text" value="{{ sur_text|escape }}">
                <input type="hidden" name="slutsats_text" value="{{ slutsats_text|escape }}">

                {% if ratings_json %}
                <input type="hidden" name="ratings_json" value="{{ ratings_json|escape }}">
                {% endif %}
{% if step == 1 %}
<h2 class="adminui-subtitle">Steg 1 ‚Äì Ladda upp underlag</h2>
<p class="adminui-intro">
  Ladda upp Excelfilen, CV och och klistra in intervjuanteckningar.
  Klicka p√• <strong>N√§sta</strong> f√∂r att skapa din rapport.
</p>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Kandidatinfo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="dn-row dn-row--two">
  <div class="dn-field-group">
    <label for="candidate_first_name">F√∂rnamn *</label>
    <input type="text"
           id="candidate_first_name"
           name="candidate_first_name"
           value="{{ candidate_first_name }}"
           class="dn-input"
           placeholder="Ange f√∂rnamn"
           required>
  </div>

  <div class="dn-field-group">
    <label for="candidate_last_name">Efternamn *</label>
    <input type="text"
           id="candidate_last_name"
           name="candidate_last_name"
           value="{{ candidate_last_name }}"
           class="dn-input"
           placeholder="Ange efternamn"
           required>
  </div>
</div>

<div class="dn-row">
  <div class="dn-field-group">
    <label for="candidate_role">Roll / tj√§nst (valfritt)</label>
    <input type="text"
           id="candidate_role"
           name="candidate_role"
           value="{{ candidate_role }}"
           class="dn-input"
           placeholder="Ange ev. roll">
  </div>
</div>

<div class="dn-row">
  <div class="dn-field-group">
    <label for="id_job_ad_text">Jobbannons / tj√§nstebeskrivning</label>
    <textarea
      id="id_job_ad_text"
      name="job_ad_text"
      rows="4"
      class="adminui-textarea"
    >{{ job_ad_text }}</textarea>
  </div>
</div>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Exceluppladdning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<h3 class="adminui-label">1. Excelfil</h3>
<p class="adminui-intro">
  Ladda upp din excelfil med testresultatet.
</p>

<div class="adminui-upload-area">
  <label for="excel" class="adminui-drop-zone">
    <input type="file" name="excel" id="excel" accept=".xlsx" style="display:none"
           onchange="showFilename(this)">
    <div class="adminui-drop-icon">üìÅ</div>
    <div class="adminui-drop-text">
      <span>Sl√§pp Excelfil h√§r eller klicka f√∂r att v√§lja</span>
      <small>Excel-format (.xlsx)</small>
    </div>
  </label>
  <p id="filename" class="adminui-filename">Ingen fil vald</p>
</div>

<!-- Hidden field f√∂r att b√§ra med sammanfogad text mellan stegen -->
<input type="hidden" name="uploaded_files_text"
       value="{{ uploaded_files_text|default_if_none:'' }}">

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CV-text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<h3 class="adminui-label">2. CV (klistra in text)</h3>
<p class="adminui-intro">
  Klistra in texten fr√•n kandidatens CV. Det g√∂r inget om den √§r r√∂rig ‚Äì AI hj√§lper dig att st√§da upp den.
</p>

<div class="dn-row">
  <div class="dn-field-group">
    <textarea
      name="cv_text"
      id="cv_text"
      rows="8"
      class="adminui-textarea"
    >{{ uploaded_files_markdown }}</textarea>
  </div>
</div>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Motivationsfaktorer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<h3 class="adminui-label">3. Motivationsfaktorer</h3>
<p class="adminui-intro">
  V√§lj upp till <strong>tre</strong> motivationsfaktorer som b√§st beskriver vad som driver kandidaten.
</p>

<div class="motivation-grid">
  {% for key, mot in motivation_factors.items %}
    <label class="motivation-card">
      <input
        type="checkbox"
        name="motivation_choices"
        value="{{ key }}"
        class="motivation-checkbox"
        {% if key in selected_motivation_keys %}checked{% endif %}
      >
      <span class="motivation-title">{{ mot.label }}</span>
    </label>
  {% endfor %}
</div>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Motivation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="dn-row">
  <div class="dn-field-group">
    <label for="id_motivation_notes">Anteckningar om motivation</label>
    <textarea
      id="id_motivation_notes"
      name="motivation_notes"
      rows="4"
      class="adminui-textarea"
    >{{ motivation_notes }}</textarea>
  </div>
</div>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ F√§rdighetspo√§ng p√• samma rad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="dn-row dn-row--two">
  <div class="dn-field-group">
    <label for="id_logical_score">Logisk f√§rdighet (0‚Äì99)</label>
    <input
      type="number"
      id="id_logical_score"
      name="logical_score"
      min="0"
      max="99"
      class="dn-input"
      value="{{ logical_score }}"
    >
  </div>
  <div class="dn-field-group">
    <label for="id_verbal_score">Verbal f√§rdighet (0‚Äì99)</label>
    <input
      type="number"
      id="id_verbal_score"
      name="verbal_score"
      min="0"
      max="99"
      class="dn-input"
      value="{{ verbal_score }}"
    >
  </div>
</div>


                <h3 class="adminui-label">3. Intervjuanteckningar</h3>
                <p class="adminui-intro">
                  Klistra in anteckningar fr√•n intervjun. Anteckningarna kan vara slarviga, AI renskriver den. 
                </p>

                <textarea name="intervju" class="adminui-textarea" rows="6">{{ intervju_text }}</textarea>
                {% endif %}

                {% if step == 2 %}
                <h3 class="adminui-subtitle">Steg 2 ‚Äì TQ F√§rdighet &amp; TQ Motivation</h3>

                <label class="adminui-label">TQ F√§rdighet</label>
                <textarea class="adminui-textarea rich-text" rows="5"
                          name="tq_fardighet_text">{{ tq_fardighet_html|default:tq_fardighet_text|safe }}</textarea>

                <label class="adminui-label">TQ Motivation ‚Äì tre fr√§msta drivkrafter</label>
                <textarea class="adminui-textarea rich-text" rows="5"
                          name="tq_motivation_text">{{ tq_motivation_html|default:tq_motivation_text|safe }}</textarea>
                {% endif %}

                {% if step == 3 %}
                <h3 class="adminui-subtitle">Steg 3 ‚Äì Leda, utveckla och engagera</h3>
                {% if leda_table_html %}
                <div class="adminui-assessment-box">{{ leda_table_html|safe }}</div>
                {% endif %}
                <label class="adminui-label">Text</label>
                <textarea class="adminui-textarea rich-text" rows="6"
                          name="leda_text">{{ leda_html|default:leda_text|safe }}</textarea>
                {% endif %}

                {% if step == 4 %}
                <h3 class="adminui-subtitle">Steg 4 ‚Äì Mod och handlingskraft</h3>
                {% if mod_table_html %}
                <div class="adminui-assessment-box">{{ mod_table_html|safe }}</div>
                {% endif %}
                <label class="adminui-label">Text</label>
                <textarea class="adminui-textarea rich-text" rows="6"
                          name="mod_text">{{ mod_html|default:mod_text|safe }}</textarea>
                {% endif %}

                {% if step == 5 %}
                <h3 class="adminui-subtitle">Steg 5 ‚Äì Sj√§lvk√§nnedom och emotionell stabilitet</h3>
                {% if sjalkannedom_table_html %}
                <div class="adminui-assessment-box">{{ sjalkannedom_table_html|safe }}</div>
                {% endif %}
                <label class="adminui-label">Text</label>
                <textarea class="adminui-textarea rich-text" rows="6"
                          name="sjalkannedom_text">{{ sjalkannedom_html|default:sjalkannedom_text|safe }}</textarea>
                {% endif %}

                {% if step == 6 %}
                <h3 class="adminui-subtitle">Steg 6 ‚Äì Strategiskt t√§nkande och anpassningsf√∂rm√•ga</h3>
                {% if strategi_table_html %}
                <div class="adminui-assessment-box">{{ strategi_table_html|safe }}</div>
                {% endif %}
                <label class="adminui-label">Text</label>
                <textarea class="adminui-textarea rich-text" rows="6"
                          name="strategi_text">{{ strategi_html|default:strategi_text|safe }}</textarea>
                {% endif %}

                {% if step == 7 %}
                <h3 class="adminui-subtitle">Steg 7 ‚Äì Kommunikation och samarbete</h3>
                {% if kommunikation_table_html %}
                <div class="adminui-assessment-box">{{ kommunikation_table_html|safe }}</div>
                {% endif %}
                <label class="adminui-label">Text</label>
                <textarea class="adminui-textarea rich-text" rows="6"
                          name="kommunikation_text">{{ kommunikation_html|default:kommunikation_text|safe }}</textarea>
                {% endif %}

                {% if step == 8 %}
                <h3 class="adminui-subtitle">Steg 8 ‚Äì Styrkor / Utvecklingsomr√•den / Riskbeteenden</h3>
                <p class="adminui-intro">H√§r sammanfattas allt ovan till tre tydliga listor. Justera fritt.</p>
                <textarea class="adminui-textarea rich-text" rows="8"
                          name="sur_text">{{ sur_html|default:sur_text|safe }}</textarea>
                {% endif %}

                {% if step == 9 %}
                <h3 class="adminui-subtitle">Steg 9 ‚Äì Sammanfattande slutsats</h3>
                <p class="adminui-intro">Skriv eller justera slutbed√∂mningen baserat p√• hela bilden.</p>
                <textarea class="adminui-textarea rich-text" rows="8"
                          name="slutsats_text">{{ slutsats_html|default:slutsats_text|safe }}</textarea>
                {% endif %}

                {% if step == 10 %}
                <h3 class="adminui-subtitle">Steg 10 ‚Äì Sammanst√§llning</h3>

                <div class="dn-report">
                  <div class="dn-report-header">
                    <img src="{% static 'jurek_logo.png' %}" alt="Logotyp" class="dn-report-logo">
                  </div>

                  <div class="dn-report-body">
                    <div class="dn-report-row">
                      <div class="dn-report-col dn-report-col--left">
                        <h5 class="dn-subheading">{{ candidate_name }}</h5>
                      </div>
                      <div class="dn-report-col dn-report-col--right">
                        <h5 class="dn-subheading">{% if candidate_role %} {{ candidate_role }}{% endif %}</h5>
                      </div>
                    </div>

                    <div class="dn-report-row">
                      <div class="dn-report-col dn-report-col--left">
                        <p class="dn-body-text">
                          Alla har beteendepreferenser p√• arbetet som p√•verkar v√•rt agerande. En individs
                          preferenser p√•verkar, men dikterar inte individens beteende. Det √§r m√∂jligt att arbeta
                          utanf√∂r v√•ra naturliga preferenser, men det kr√§ver sj√§lvk√§nnedom, en medveten insats
                          och energi.
                          <br><br>
                          Skalan visar hur sannolikt en kompetens √§r stark eller ej hos en individ.
                        </p>
                      </div>
                      <div class="dn-report-col dn-report-col--right">
                        <!-- Po√§ngskale-tabellen som tidigare -->
                        <!-- ... (of√∂r√§ndrat inneh√•ll h√§r) ... -->
                        <!-- Jag l√§mnar din befintliga skaltabell of√∂r√§ndrad -->
                        {{ block.super|default:'' }}
                      </div>
                    </div>

                    <!-- Resten av dina rader (TQ F√§rdighet, Styrkor/Utvecklingsomr√•den/Risk, Motivation, Leda osv)  -->
                    <!-- Jag l√•ter inneh√•llet vara of√∂r√§ndrat h√§r, du hade redan en fin layout -->
                    {{ tq_fardighet_html|safe }}
                    {{ sur_html|safe }}
                    {{ tq_motivation_html|safe }}
                    <!-- ... + √∂vriga sektioner ... -->

                  </div>
                </div>
                {% endif %}

                <!-- NAVIGATION -->
                <div class="adminui-button-row">
                  {% if step > 1 %}
                  <button class="adminui-button adminui-button-secondary"
                          type="submit" name="prev" value="1">
                    ‚¨Ö F√∂reg√•ende
                  </button>
                  {% endif %}

                  {% if step < 9 %}
                  <button class="adminui-button" type="submit" name="next" value="1">
                    N√§sta ‚ûú
                  </button>
                  {% elif step == 9 %}
                  <button class="adminui-button" type="submit" name="next" value="1">
                    Sammanst√§ll ‚ûú
                  </button>
                  {% elif step == 10 %}
                  <button class="adminui-button" type="submit" name="build_doc" value="1">
                    üìÑ Ladda ner som Word
                  </button>
                  {% endif %}
                </div>

              </form>

            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- H√ñGERSPALT / PLATS F√ñR CHATT -->
    <aside class="right-panel">
      <div class="right-panel-tabs">
        <button class="right-tab right-tab--active" data-tab="data">Din data</button>
        <button class="right-tab" data-tab="chat">Chatt</button>
      </div>

<div id="tab-data" class="right-panel-pane is-active">
  <h3 class="assistant-title">Din data</h3>

  {% if has_sidebar_data %}

    {# ‚ñ∏ KANDIDAT #}
    <section class="dn-data-block">
      <h4 class="dn-section-header">Kandidat</h4>
      <dl class="dn-deflist">
        {% if candidate_name %}
        <div class="dn-row">
          <dt>Namn</dt>
          <dd>{{ candidate_name }}</dd>
        </div>
        {% endif %}

        {% if candidate_role %}
        <div class="dn-row">
          <dt>Roll / tj√§nst</dt>
          <dd>{{ candidate_role }}</dd>
        </div>
        {% endif %}

        {% if logical_score %}
        <div class="dn-row">
          <dt>Logisk f√§rdighet</dt>
          <dd>{{ logical_score }}</dd>
        </div>
        {% endif %}

        {% if verbal_score %}
        <div class="dn-row">
          <dt>Verbal f√§rdighet</dt>
          <dd>{{ verbal_score }}</dd>
        </div>
        {% endif %}
      </dl>
    </section>

    {# ‚ñ∏ MOTIVATIONSFAKTORER #}
    {% if selected_motivations %}
    <section class="dn-data-block">
      <h4 class="dn-section-header">Motivationsfaktorer (valda)</h4>
      <div class="dn-motivation-grid">
        {% for mot in selected_motivations %}
        <article class="dn-motivation-card">
          <h5 class="dn-motivation-title">{{ mot.label }}</h5>
          <p class="dn-motivation-text">{{ mot.definition }}</p>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# ‚ñ∏ BETYG / RATINGS #}
    {% if ratings_sidebar %}
    <section class="dn-data-block">
      {% for section_title, items in ratings_sidebar.items %}
      <div class="dn-ratings-section">
        <h4 class="dn-section-header">{{ section_title }}</h4>
        <dl class="dn-deflist dn-deflist--compact">
          {% for item in items %}
          <div class="dn-row">
            <dt>{{ item.label }}</dt>
            <dd>{{ item.value }}</dd>
          </div>
          {% endfor %}
        </dl>
      </div>
      {% endfor %}
    </section>
    {% endif %}

    {# ‚ñ∏ L√ÑNGRE TEXTER #}
    {% if cv_text or job_ad_text or motivation_notes or intervju_text %}
    <section class="dn-data-block">
      <h4 class="dn-section-header">L√§ngre texter</h4>
      <div class="dn-chip-row">
        {% if cv_text %}
        <button type="button"
                class="adminui-button adminui-button-secondary dn-chip-button"
                id="showPdfTextBtn">
          Visa CV
        </button>
        {% endif %}

        {% if job_ad_text %}
        <button type="button"
                class="adminui-button adminui-button-secondary dn-chip-button"
                id="showJobAdBtn">
          Visa jobbannons
        </button>
        {% endif %}

        {% if motivation_notes %}
        <button type="button"
                class="adminui-button adminui-button-secondary dn-chip-button"
                id="showMotivationNotesBtn">
          Visa motivationsanteckningar
        </button>
        {% endif %}

        {% if intervju_text %}
        <button type="button"
                class="adminui-button adminui-button-secondary dn-chip-button"
                id="showInterviewNotesBtn">
          Visa intervjuanteckningar
        </button>
        {% endif %}
      </div>
    </section>
    {% endif %}

  {% else %}
    <p class="adminui-intro">
      N√§r du laddat upp material kommer det att visas h√§r.
    </p>
  {% endif %}
</div>

      <div id="tab-chat" class="right-panel-pane">
        <div id="sidebar-chat"
             data-session-id="{{ sidebar_session_id }}"
             data-sidebar-context='{{ sidebar_context_json|escapejs }}'>

          {% if not sidebar_messages %}
          <p id="sidebar-chat-empty" class="sidebar-chat-empty">
            <strong>V√§lkommen till chatten</strong>
            <span>Skriv ett meddelande f√∂r att komma ig√•ng</span>
            <span class="sidebar-chat-arrow">‚Üì</span>
          </p>
          {% endif %}

          <div id="sidebar-chat-messages" class="sidebar-chat-messages">
            {% for msg in sidebar_messages %}
            <div class="sidebar-chat-msg sidebar-chat-msg--{{ msg.role }}">
              {{ msg.content|linebreaksbr }}
            </div>
            {% endfor %}
          </div>

          <form id="sidebar-chat-form">
            {% csrf_token %}
            <textarea id="sidebar-chat-input" class="adminui-textarea" rows="2"
                      placeholder="Skriv t.ex. ‚Äòg√∂r texten kortare‚Äô"></textarea>
            <button type="submit" class="adminui-button adminui-button-small">Skicka</button>
          </form>
        </div>
      </div>
    </aside>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const forms = document.querySelectorAll("form");
      const overlay = document.getElementById("loading-overlay");

      if (overlay) {
        forms.forEach(form => {
          form.addEventListener("submit", function (e) {
            const btn = e.submitter;
            if (!btn) return;

            const heavyActions = [
              "next", "gen_tq_fardighet", "gen_tq_motivation",
              "gen_leda", "gen_mod", "gen_sjalkannedom",
              "gen_strategi", "gen_kommunikation", "gen_sur",
              "gen_slutsats", "generate_analysis"
            ];

            if (heavyActions.includes(btn.name)) {
              overlay.style.display = "flex";
            }
          });
        });
      }

      // -------- POPUPS / MODALER --------
      const modalPairs = [
        { buttonId: "showPdfTextBtn",          modalId: "pdfTextModal" },
        { buttonId: "showJobAdBtn",           modalId: "jobAdModal" },
        { buttonId: "showMotivationNotesBtn", modalId: "motivationNotesModal" },
        { buttonId: "showInterviewNotesBtn",  modalId: "interviewNotesModal" },
      ];

      modalPairs.forEach(({ buttonId, modalId }) => {
        const btn   = document.getElementById(buttonId);
        const modal = document.getElementById(modalId);
        if (!btn || !modal) return;

        const close = modal.querySelector(".dn-modal-close");

        btn.addEventListener("click", () => modal.classList.add("is-open"));
        if (close) {
          close.addEventListener("click", () => modal.classList.remove("is-open"));
        }
        modal.addEventListener("click", (e) => {
          if (e.target === modal || e.target.classList.contains("dn-modal-backdrop")) {
            modal.classList.remove("is-open");
          }
        });
      });
    });
  </script>

  <!-- LOADING OVERLAY -->
  <div id="loading-overlay">
    <div class="loading-box">
      <div class="loading-spinner"></div>
      <p>üß† AI t√§nker... snart klar!</p>
    </div>
  </div>

  {% if uploaded_files_html %}
  <div id="pdfTextModal" class="dn-modal">
    <div class="dn-modal-backdrop"></div>
    <div class="dn-modal-content">
      <button type="button" id="closePdfTextModal" class="dn-modal-close">√ó</button>
      <h3>Text fr√•n PDF-uppladdning</h3>

      <div class="dn-modal-body markdown-body">
        {{ uploaded_files_html|safe }}
      </div>
    </div>
  </div>
  {% endif %}

  {% if job_ad_text %}
<div id="jobAdModal" class="dn-modal">
  <div class="dn-modal-backdrop"></div>
  <div class="dn-modal-content">
    <button type="button" class="dn-modal-close" data-close-modal>√ó</button>
    <h3>Jobbannons / tj√§nstebeskrivning</h3>
    <div class="dn-modal-body markdown-body">
      {{ job_ad_text|linebreaksbr }}
    </div>
  </div>
</div>
{% endif %}

{% if motivation_notes %}
<div id="motivationNotesModal" class="dn-modal">
  <div class="dn-modal-backdrop"></div>
  <div class="dn-modal-content">
    <button type="button" class="dn-modal-close" data-close-modal>√ó</button>
    <h3>Anteckningar om motivation</h3>
    <div class="dn-modal-body markdown-body">
      {{ motivation_notes|linebreaksbr }}
    </div>
  </div>
</div>
{% endif %}

{% if intervju_text %}
<div id="interviewNotesModal" class="dn-modal">
  <div class="dn-modal-backdrop"></div>
  <div class="dn-modal-content">
    <button type="button" class="dn-modal-close" data-close-modal>√ó</button>
    <h3>Intervjuanteckningar</h3>
    <div class="dn-modal-body markdown-body">
      {{ intervju_text|linebreaksbr }}
    </div>
  </div>
</div>
{% endif %}

  <script src="{% static 'js/script.js' %}"></script>

  <!-- Libs i rimlig ordning -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/trumbowyg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const ratingBlocks = document.querySelectorAll('.rating-export');
    if (!ratingBlocks.length) return;

    ratingBlocks.forEach(function (block) {
      block.style.backgroundColor = '#ffffff';

      html2canvas(block, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true
      }).then(function (canvas) {
        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        img.alt = 'Kompetenstabell';
        img.style.maxWidth = '100%';
        img.style.display = 'block';

        block.innerHTML = '';
        block.appendChild(img);
      }).catch(err => console.error('Canvas error:', err));
    });
  });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const tabButtons = document.querySelectorAll('.right-tab');
    const tabPanels  = document.querySelectorAll('.right-panel-pane');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;

        tabButtons.forEach(b =>
          b.classList.toggle('right-tab--active', b === btn)
        );

        tabPanels.forEach(p =>
          p.classList.toggle('is-active', p.id === 'tab-' + target)
        );
      });
    });

    const chatRoot = document.getElementById('sidebar-chat');
    if (!chatRoot) return;

    const sessionId = chatRoot.dataset.sessionId;
    const chatForm  = document.getElementById('sidebar-chat-form');
    const chatInput = document.getElementById('sidebar-chat-input');
    const chatMsgs  = document.getElementById('sidebar-chat-messages');
    const stepInput = document.querySelector('input[name="step"]');

    const csrfTokenEl = chatForm.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrftoken = csrfTokenEl ? csrfTokenEl.value : "";

    function renderMarkdown(text) {
      if (window.marked) {
        return marked.parse(text);
      }
      return text.replace(/\n/g, '<br>');
    }

    function createMessageElement(role) {
      const empty = document.getElementById('sidebar-chat-empty');
      if (empty) empty.style.display = 'none';

      const div = document.createElement('div');
      div.className = 'sidebar-chat-msg sidebar-chat-msg--' + role;
      chatMsgs.appendChild(div);
      chatMsgs.scrollTop = chatMsgs.scrollHeight;
      return div;
    }

    function getFieldText(name) {
      const el = document.querySelector('[name="' + name + '"]');
      if (!el) return "";
      if ('value' in el) return el.value || "";
      return el.textContent || "";
    }

    function getCurrentStepText() {
      const step = parseInt(stepInput ? stepInput.value : "1", 10);

      switch (step) {
        case 2:
          return (
            getFieldText("tq_fardighet_text") +
            "\n\n" +
            getFieldText("tq_motivation_text")
          );
        case 3:
          return getFieldText("leda_text");
        case 4:
          return getFieldText("mod_text");
        case 5:
          return getFieldText("sjalkannedom_text");
        case 6:
          return getFieldText("strategi_text");
        case 7:
          return getFieldText("kommunikation_text");
        case 8:
          return getFieldText("sur_text");
        case 9:
          return getFieldText("slutsats_text");
        default:
          return "";
      }
    }

    function buildSidebarContext() {
      const step = parseInt(stepInput ? stepInput.value : "1", 10);
      const ctx = {
        step: step,
        candidate_name: getFieldText("candidate_name"),
        candidate_role: getFieldText("candidate_role"),
        test_text: getFieldText("test_text"),
        intervju_text: getFieldText("intervju_text"),
        cv_text: getFieldText("cv_text"),
        sections: []
      };

      const currentText = getCurrentStepText();

      if (step === 2) {
        ctx.sections.push({
          field_label: "TQ F√§rdighet & TQ Motivation",
          field_key: "step2",
          prompt_name: "tq_fardighet_motivation",
          prompt_text: "",
          current_text: currentText
        });
      } else if (step === 3) {
        ctx.sections.push({
          field_label: "Leda, utveckla och engagera",
          field_key: "leda_text",
          prompt_name: "leda",
          current_text: currentText
        });
      } else if (step === 4) {
        ctx.sections.push({
          field_label: "Mod och handlingskraft",
          field_key: "mod_text",
          prompt_name: "mod",
          current_text: currentText
        });
      } else if (step === 5) {
        ctx.sections.push({
          field_label: "Sj√§lvk√§nnedom och emotionell stabilitet",
          field_key: "sjalkannedom_text",
          prompt_name: "sjalkannedom",
          current_text: currentText
        });
      } else if (step === 6) {
        ctx.sections.push({
          field_label: "Strategiskt t√§nkande och anpassningsf√∂rm√•ga",
          field_key: "strategi_text",
          prompt_name: "strategi",
          current_text: currentText
        });
      } else if (step === 7) {
        ctx.sections.push({
          field_label: "Kommunikation och samarbete",
          field_key: "kommunikation_text",
          prompt_name: "kommunikation",
          current_text: currentText
        });
      } else if (step === 8) {
        ctx.sections.push({
          field_label: "Styrkor / Utvecklingsomr√•den / Riskbeteenden",
          field_key: "sur_text",
          prompt_name: "styrkor_utveckling_risk",
          current_text: currentText
        });
      } else if (step === 9) {
        ctx.sections.push({
          field_label: "Sammanfattande slutsats",
          field_key: "slutsats_text",
          prompt_name: "sammanfattande_slutsats",
          current_text: currentText
        });
      }

      return JSON.stringify(ctx);
    }

    async function sendSidebarMessage() {
      const msg = (chatInput.value || "").trim();
      if (!msg) return;

      const userDiv = createMessageElement('user');
      userDiv.innerHTML = renderMarkdown(msg);
      chatInput.value = '';

      const url = `/chat/${sessionId}/send/`;
      const formData = new FormData();
      formData.append('message', msg);
      formData.append('sidebar_context', buildSidebarContext());

      const assistantDiv = createMessageElement('assistant');
      let assistantText = "";

      try {
        const res = await fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
          }
        });

        if (!res.ok || !res.body) {
          assistantDiv.innerHTML = '(Kunde inte h√§mta svar fr√•n chatten.)';
          return;
        }

        const reader  = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          assistantText += decoder.decode(value, { stream: true });

          let cleaned = assistantText
            .replace(/\r/g, '')
            .replace(/\n{2,}/g, '\n')
            .replace(/[ \t]+\n/g, '\n')
            .trimStart();

          const copyMatch = cleaned.match(/<copy>([\s\S]*?)<\/copy>/);

          let htmlOutput = '';

          if (copyMatch) {
            const before = cleaned.split('<copy>')[0].trim();

            const copyText = copyMatch[1]
              .replace(/\r/g, '')
              .replace(/\n{2,}/g, '\n')
              .replace(/[ \t]+\n/g, '\n')
              .trim();

            htmlOutput =
              (before ? renderMarkdown(before) : '') +
              renderMarkdown('```text\n' + copyText + '\n```');
          } else {
            htmlOutput = renderMarkdown(cleaned);
          }

          assistantDiv.innerHTML = htmlOutput;
          chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }
      } catch (err) {
        assistantDiv.innerHTML = '(Fel i chatt-anropet: ' + err + ')';
        console.error(err);
      }
    }

    chatInput.addEventListener('keydown', function (e) {
      if (e.key === "Enter" && e.shiftKey) {
        return;
      }
      if (e.key === "Enter") {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    chatForm.addEventListener('submit', function (e) {
      e.preventDefault();
      sendSidebarMessage();
    });
  });
  </script>

  <script>
  $(document).ready(function() {
    $('textarea.rich-text').trumbowyg({
      btns: [
        ['strong', 'em', 'underline'],
        ['unorderedList', 'orderedList'],
        ['link'],
        ['removeformat']
      ]
    });
  });
  </script>

  <script>
document.addEventListener('DOMContentLoaded', function () {
  const checkboxes = document.querySelectorAll('.motivation-checkbox');
  const maxSelected = 3;

  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const selected = Array.from(checkboxes).filter(x => x.checked);
      if (selected.length > maxSelected) {
        // Avmarkera senaste klicket
        cb.checked = false;
        alert('Du kan v√§lja h√∂gst ' + maxSelected + ' motivationsfaktorer.');
      }
    });
  });
});
</script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>

</html>
