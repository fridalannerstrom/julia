{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Julia</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Din egna styles (ligger efter s√• den vinner) -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <link rel="icon" href="{% static 'img/favicon.ico' %}">

    <style>
      /* LOADING OVERLAY ‚Äì bara detta lokalt */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .loading-box {
        background: #fff;
        padding: 22px 30px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        min-width: 200px;
        text-align: center;
      }

      .loading-spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 4px solid #e5e7eb;
        border-top-color: #7b2cbf;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      #loading-overlay p {
        font-size: 1rem;
        color: #111827;
        margin: 0;
        font-weight: 500;
      }
    </style>
</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <div class="container px-4">
            <a class="navbar-brand" href="#page-top">Julia AI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active text-white" href="{% url 'index' %}">Verktyget</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'prompt_editor' %}">√Ñndra prompts</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'chat_home' %}">Chatt</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header-->
    <header class="bg-primary bg-gradient text-white">
        <div class="container px-4 text-center">
            <h1 class="fw-bolder">Domarn√§mnden</h1>
        </div>
    </header>

    <!-- Main -->
<section id="about">
    {% if error %}
    <div class="adminui-alert">
        {{ error }}
    </div>
    {% endif %}

    <div class="container px-4">
        <div class="row gx-4 justify-content-center">
            <div class="col-xl-7 col-lg-8">
                <div class="adminui-container">

                    <!-- Header + steg-indikator -->
                    <div class="adminui-header">
                        <div>
                            <h2 class="adminui-title">Domarn√§mnden ‚Äì Stegvis analys</h2>
                            <p class="adminui-help">
                                F√∂lj stegen i ordning. Varje steg anv√§nder bara den information som beh√∂vs,
                                s√• AI-belastningen h√•lls nere och du kan justera texten l√§ngs v√§gen.
                            </p>
                        </div>
                        <div class="adminui-step-box">
                            <span class="adminui-step-label">Steg</span>
                            <span class="adminui-step-value">{{ step }} / 10</span>
                        </div>
                    </div>

                    <!-- Progressbar -->
                    <div class="adminui-progress"
                         style="--current-step: {{ step }}; --total-steps: 10;">
                        <div class="adminui-progress-bar"></div>
                    </div>

                    <form method="post" enctype="multipart/form-data" class="adminui-form">
                        {% csrf_token %}

                        <!-- HIDDEN STATE -->
                        <input type="hidden" name="step" value="{{ step }}">
                        <input type="hidden" name="test_text" value="{{ test_text|escape }}">
                        <input type="hidden" name="intervju_text" value="{{ intervju_text|escape }}">
                        <input type="hidden" name="tq_fardighet_text" value="{{ tq_fardighet_text|escape }}">
                        <input type="hidden" name="tq_motivation_text" value="{{ tq_motivation_text|escape }}">
                        <input type="hidden" name="leda_text" value="{{ leda_text|escape }}">
                        <input type="hidden" name="mod_text" value="{{ mod_text|escape }}">
                        <input type="hidden" name="sjalkannedom_text" value="{{ sjalkannedom_text|escape }}">
                        <input type="hidden" name="strategi_text" value="{{ strategi_text|escape }}">
                        <input type="hidden" name="kommunikation_text" value="{{ kommunikation_text|escape }}">
                        <input type="hidden" name="sur_text" value="{{ sur_text|escape }}">
                        <input type="hidden" name="slutsats_text" value="{{ slutsats_text|escape }}">
                        {% if ratings_json %}
                            <input type="hidden" name="ratings_json" value="{{ ratings_json|escape }}">
                        {% endif %}

                        <!-- STEG 1 -->
                        {% if step == 1 %}
                            <h3 class="adminui-subtitle">Steg 1 ‚Äì Ladda upp underlag</h3>
                            <p class="adminui-intro">
                                Ladda upp Excelfilen och klistra in intervjuanteckningar.
                                Klicka p√• <strong>N√§sta</strong> f√∂r att skapa TQ F√§rdighet &amp; TQ Motivation.
                            </p>

                            <div class="adminui-upload-area">
                                <label for="excel" class="adminui-drop-zone">
                                    <input type="file" name="excel" id="excel" hidden onchange="showFilename(this)">
                                    <div class="adminui-drop-icon">üìÅ</div>
                                    <div class="adminui-drop-text">
                                        <span>Sl√§pp fil h√§r eller klicka f√∂r att v√§lja</span>
                                        <small>Excel-format (.xlsx)</small>
                                    </div>
                                </label>
                                <p id="filename" class="adminui-filename">Ingen fil vald</p>
                            </div>

                            <label class="adminui-label">Intervjuanteckningar</label>
                            <textarea name="intervju" class="adminui-textarea" rows="6">{{ intervju_text }}</textarea>
                        {% endif %}

                        <!-- STEG 2: TQ F/M -->
                        {% if step == 2 %}
                            <h3 class="adminui-subtitle">Steg 2 ‚Äì TQ F√§rdighet &amp; TQ Motivation</h3>

                            <label class="adminui-label">TQ F√§rdighet</label>
                            <textarea class="adminui-textarea" rows="5" name="tq_fardighet_text">{{ tq_fardighet_text }}</textarea>

                            <label class="adminui-label">TQ Motivation ‚Äì tre fr√§msta drivkrafter</label>
                            <textarea class="adminui-textarea" rows="5" name="tq_motivation_text">{{ tq_motivation_text }}</textarea>
                        {% endif %}

                        <!-- STEG 3: Leda -->
                        {% if step == 3 %}
                            <h3 class="adminui-subtitle">Steg 3 ‚Äì Leda, utveckla och engagera</h3>
                            {% if leda_table_html %}
                                <div class="adminui-assessment-box">{{ leda_table_html|safe }}</div>
                            {% endif %}
                            <label class="adminui-label">Text</label>
                            <textarea class="adminui-textarea" rows="6" name="leda_text">{{ leda_text }}</textarea>
                        {% endif %}

                        <!-- STEG 4: Mod -->
                        {% if step == 4 %}
                            <h3 class="adminui-subtitle">Steg 4 ‚Äì Mod och handlingskraft</h3>
                            {% if mod_table_html %}
                                <div class="adminui-assessment-box">{{ mod_table_html|safe }}</div>
                            {% endif %}
                            <label class="adminui-label">Text</label>
                            <textarea class="adminui-textarea" rows="6" name="mod_text">{{ mod_text }}</textarea>
                        {% endif %}

                        <!-- STEG 5: Sj√§lvk√§nnedom -->
                        {% if step == 5 %}
                            <h3 class="adminui-subtitle">Steg 5 ‚Äì Sj√§lvk√§nnedom och emotionell stabilitet</h3>
                            {% if sjalkannedom_table_html %}
                                <div class="adminui-assessment-box">{{ sjalkannedom_table_html|safe }}</div>
                            {% endif %}
                            <label class="adminui-label">Text</label>
                            <textarea class="adminui-textarea" rows="6" name="sjalkannedom_text">{{ sjalkannedom_text }}</textarea>
                        {% endif %}

                        <!-- STEG 6: Strategi -->
                        {% if step == 6 %}
                            <h3 class="adminui-subtitle">Steg 6 ‚Äì Strategiskt t√§nkande och anpassningsf√∂rm√•ga</h3>
                            {% if strategi_table_html %}
                                <div class="adminui-assessment-box">{{ strategi_table_html|safe }}</div>
                            {% endif %}
                            <label class="adminui-label">Text</label>
                            <textarea class="adminui-textarea" rows="6" name="strategi_text">{{ strategi_text }}</textarea>
                        {% endif %}

                        <!-- STEG 7: Kommunikation -->
                        {% if step == 7 %}
                            <h3 class="adminui-subtitle">Steg 7 ‚Äì Kommunikation och samarbete</h3>
                            {% if kommunikation_table_html %}
                                <div class="adminui-assessment-box">{{ kommunikation_table_html|safe }}</div>
                            {% endif %}
                            <label class="adminui-label">Text</label>
                            <textarea class="adminui-textarea" rows="6" name="kommunikation_text">{{ kommunikation_text }}</textarea>
                        {% endif %}

                        <!-- STEG 8: SUR -->
                        {% if step == 8 %}
                            <h3 class="adminui-subtitle">Steg 8 ‚Äì Styrkor / Utvecklingsomr√•den / Riskbeteenden</h3>
                            <p class="adminui-intro">H√§r sammanfattas allt ovan till tre tydliga listor. Justera fritt.</p>
                            <textarea class="adminui-textarea" rows="8" name="sur_text">{{ sur_text }}</textarea>
                        {% endif %}

                        <!-- STEG 9: Slutsats -->
                        {% if step == 9 %}
                            <h3 class="adminui-subtitle">Steg 9 ‚Äì Sammanfattande slutsats</h3>
                            <p class="adminui-intro">Skriv eller justera slutbed√∂mningen baserat p√• hela bilden.</p>
                            <textarea class="adminui-textarea" rows="8" name="slutsats_text">{{ slutsats_text }}</textarea>
                        {% endif %}

                        <!-- STEG 10: Sammanst√§llning -->
                        {% if step == 10 %}
                            <h3 class="adminui-subtitle">Steg 10 ‚Äì Sammanst√§llning</h3>
                            <p class="adminui-intro">
                                H√§r ser du hela rapporten samlad, utan nya AI-anrop. Kontrollera innan du laddar ner Word.
                            </p>

                            <div class="adminui-report-preview">

                                {% if tq_fardighet_text %}
                                <div class="report-section">
                                    <h3>TQ F√§rdighet</h3>
                                    <div class="report-body">
                                        {{ tq_fardighet_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if sur_text %}
                                <div class="report-section">
                                    <h3>Styrkor / Utvecklingsomr√•den / Riskbeteenden</h3>
                                    <div class="report-body">
                                        {{ sur_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if tq_motivation_text %}
                                <div class="report-section">
                                    <h3>TQ Motivation ‚Äì fr√§msta drivkrafter</h3>
                                    <div class="report-body">
                                        {{ tq_motivation_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if leda_text %}
                                <div class="report-section">
                                    <h3>Leda, utveckla och engagera</h3>
                                    {% if leda_table_html %}
                                        <div class="report-table">
                                            {{ leda_table_html|safe }}
                                        </div>
                                    {% endif %}
                                    <div class="report-body">
                                        {{ leda_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if mod_text %}
                                <div class="report-section">
                                    <h3>Mod och handlingskraft</h3>
                                    {% if mod_table_html %}
                                        <div class="report-table">
                                            {{ mod_table_html|safe }}
                                        </div>
                                    {% endif %}
                                    <div class="report-body">
                                        {{ mod_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if sjalkannedom_text %}
                                <div class="report-section">
                                    <h3>Sj√§lvk√§nnedom och emotionell stabilitet</h3>
                                    {% if sjalkannedom_table_html %}
                                        <div class="report-table">
                                            {{ sjalkannedom_table_html|safe }}
                                        </div>
                                    {% endif %}
                                    <div class="report-body">
                                        {{ sjalkannedom_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if strategi_text %}
                                <div class="report-section">
                                    <h3>Strategiskt t√§nkande och anpassningsf√∂rm√•ga</h3>
                                    {% if strategi_table_html %}
                                        <div class="report-table">
                                            {{ strategi_table_html|safe }}
                                        </div>
                                    {% endif %}
                                    <div class="report-body">
                                        {{ strategi_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if kommunikation_text %}
                                <div class="report-section">
                                    <h3>Kommunikation och samarbete</h3>
                                    {% if kommunikation_table_html %}
                                        <div class="report-table">
                                            {{ kommunikation_table_html|safe }}
                                        </div>
                                    {% endif %}
                                    <div class="report-body">
                                        {{ kommunikation_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if slutsats_text %}
                                <div class="report-section">
                                    <h3>Sammanfattande slutsats</h3>
                                    <div class="report-body">
                                        {{ slutsats_text|linebreaksbr }}
                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        {% endif %}

                        <!-- NAVIGATION -->
                        <div class="adminui-button-row">
                            {% if step > 1 %}
                                <button class="adminui-button adminui-button-secondary" type="submit" name="prev" value="1">
                                    ‚¨Ö F√∂reg√•ende
                                </button>
                            {% endif %}

                            {% if step < 9 %}
                                <button class="adminui-button" type="submit" name="next" value="1">
                                    N√§sta ‚ûú
                                </button>
                            {% elif step == 9 %}
                                <button class="adminui-button" type="submit" name="next" value="1">
                                    Sammanst√§ll ‚ûú
                                </button>
                            {% elif step == 10 %}
                                <button class="adminui-button" type="submit" name="build_doc" value="1">
                                    üìÑ Ladda ner som Word
                                </button>
                            {% endif %}
                        </div>

                    </form>

                </div>
            </div>
        </div>
    </div>
</section>


    <!-- Footer-->
    <footer class="py-5 bg-dark">
        <div class="container px-4"><p class="m-0 text-center text-white">Copyright &copy; TQ Nordic</p></div>
    </footer>

    <script>
        function showFilename(input) {
            const fileName = input.files[0] ? input.files[0].name : "Ingen fil vald";
            document.getElementById("filename").textContent = "Vald fil: " + fileName;
        }
    </script>

<script>
function showFilename(input) {
  const fileName = input.files[0] ? input.files[0].name : "Ingen fil vald";
  const el = document.getElementById("filename");
  if (el) el.textContent = "Vald fil: " + fileName;
}

document.addEventListener("DOMContentLoaded", function () {
  const forms = document.querySelectorAll("form");
  const overlay = document.getElementById("loading-overlay");

  if (!overlay) return;

  forms.forEach(form => {
    form.addEventListener("submit", function (e) {
      const btn = e.submitter;
      if (!btn) return;

      const heavyActions = [
        "next",
        "gen_tq_fardighet",
        "gen_tq_motivation",
        "gen_leda",
        "gen_mod",
        "gen_sjalkannedom",
        "gen_strategi",
        "gen_kommunikation",
        "gen_sur",
        "gen_slutsats",
        "generate_analysis"
      ];

      if (heavyActions.includes(btn.name)) {
        overlay.style.display = "flex";
      }
      // build_doc k√∂r utan overlay üëç
    });
  });
});
</script>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="{% static 'js/script.js' %}"></script>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
  <div class="loading-box">
    <div class="loading-spinner"></div>
    <p>üß† AI t√§nker... snart klar!</p>
  </div>
</div>
</body>
</html>
