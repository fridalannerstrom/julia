{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Julia â€“ Rapporter</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Din egna styles -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body id="page-top">
  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <span class="brand-dot"></span>
        <span class="brand-text">Julia AI</span>
      </div>

      <nav class="sidebar-nav">
        <a href="{% url 'index' %}" class="sidebar-link">
          <span class="sidebar-icon">âš™ï¸</span>
          <span>Verktyget</span>
        </a>

        <a href="{% url 'report_list' %}" class="sidebar-link sidebar-link-active">
          <span class="sidebar-icon">ğŸ“„</span>
          <span>Rapporter</span>
        </a>

        <a href="{% url 'prompt_editor' %}" class="sidebar-link">
          <span class="sidebar-icon">ğŸ“</span>
          <span>Ã„ndra prompts</span>
        </a>

        <a href="{% url 'chat_home' %}" class="sidebar-link">
          <span class="sidebar-icon">ğŸ’¬</span>
          <span>Chatt</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-chip">
          <div class="user-avatar">
            {{ user.first_name|default:"J"|first }}
          </div>
          <div class="user-meta">
            <span>Inloggad som</span>
            <strong>{{ user.first_name|default:user.username }} {{ user.last_name }}</strong>
          </div>
        </div>
        <button class="logout-btn" type="button">Logga ut</button>
        <p class="sidebar-copy">Â© TQ Nordic</p>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-area">
      <header class="page-header">
        <div>
          <h1>Rapporter</h1>
          <p>Ã–ppna, redigera eller ladda ner tidigare rapporter.</p>
        </div>

        <div class="page-header-meta">
          <a class="pill pill-soft" href="{% url 'index' %}">+ Ny rapport</a>
        </div>
      </header>

      <section class="reports-wrap">
        <!-- Toolbar -->
        <div class="reports-toolbar">
          <div class="reports-search">
            <span class="reports-search-icon">ğŸ”</span>
            <input
              type="search"
              class="reports-search-input"
              placeholder="SÃ¶k pÃ¥ namn, roll eller datum..."
              id="reportsSearch"
              autocomplete="off"
            >
          </div>

          <div class="reports-filters">
            <select class="reports-select" id="reportsSort">
              <option value="newest" selected>Sortera: Senast Ã¤ndrad</option>
              <option value="oldest">Sortera: Ã„ldst fÃ¶rst</option>
              <option value="name_az">Sortera: Namn Aâ€“Ã–</option>
              <option value="name_za">Sortera: Namn Ã–â€“A</option>
            </select>
          </div>
        </div>

        <!-- List -->
        {% if reports %}
          <div class="reports-grid" id="reportsGrid">
            {% for r in reports %}
              <article class="report-card"
                       data-title="{{ r.title|default:''|lower }}"
                       data-name="{{ r.candidate_name|default:r.title|default:''|lower }}"
                       data-role="{{ r.candidate_role|default:''|lower }}"
                       data-updated="{{ r.updated_at|date:'U' }}">

                <div class="report-card-top">
<span class="report-badge">
  Skapad av: {{ r.created_by.get_full_name|default:r.created_by.username }}
</span>

                  <div class="report-meta">
                    <span class="report-meta-dot"></span>
                    <span class="report-meta-text">
                      Uppdaterad {{ r.updated_at|date:"Y-m-d H:i" }}
                    </span>
                  </div>
                </div>

                <h3 class="report-title">
                  {{ r.candidate_name|default:r.title|default:"Rapport" }}
                </h3>

                <div class="report-actions">
                  <a class="adminui-button adminui-button-secondary report-action"
                     href="{% url 'report_open' r.id %}">
                    Ã–ppna
                  </a>

                  <a class="adminui-button adminui-button-secondary report-action"
                     href="{% url 'report_edit' r.id %}">
                    Redigera
                  </a>

                  <a class="adminui-button report-action"
                     href="{% url 'report_download' r.id %}">
                    Ladda ner
                  </a>

                  <form method="post"
                        action="{% url 'report_delete' r.id %}"
                        class="report-delete-form">
                    {% csrf_token %}
                    <button type="submit"
                            class="report-trash"
                            title="Ta bort"
                            aria-label="Ta bort">
                      ğŸ—‘ï¸
                    </button>
                  </form>
                </div>

              </article>
            {% endfor %}
          </div>
        {% else %}
          <div class="reports-empty">
            <div class="reports-empty-icon">ğŸ“„</div>
            <h3>Inga rapporter Ã¤nnu</h3>
            <p>Skapa din fÃ¶rsta rapport i verktyget, sÃ¥ dyker den upp hÃ¤r.</p>
            <a class="adminui-button" href="{% url 'index' %}">+ Skapa ny rapport</a>
          </div>
        {% endif %}
      </section>
    </main>

  </div>

  <!-- Minimal JS fÃ¶r sÃ¶k + sort -->
  <script>
    (function () {
      const search = document.getElementById('reportsSearch');
      const sort = document.getElementById('reportsSort');
      const grid = document.getElementById('reportsGrid');

      if (!grid) return;

      function getCards() {
        return Array.from(grid.querySelectorAll('.report-card'));
      }

      function applyFilter() {
        const q = (search.value || '').trim().toLowerCase();
        getCards().forEach(card => {
          const hay = [
            card.dataset.title || '',
            card.dataset.name || '',
            card.dataset.role || ''
          ].join(' ');
          card.style.display = hay.includes(q) ? '' : 'none';
        });
      }

      function applySort() {
        const cards = getCards();
        const mode = sort.value;

        cards.sort((a, b) => {
          const au = parseInt(a.dataset.updated || '0', 10);
          const bu = parseInt(b.dataset.updated || '0', 10);

          const an = (a.dataset.name || '').localeCompare(b.dataset.name || '', 'sv');
          const bn = (b.dataset.name || '').localeCompare(a.dataset.name || '', 'sv');

          if (mode === 'newest') return bu - au;
          if (mode === 'oldest') return au - bu;
          if (mode === 'name_az') return (a.dataset.name || '').localeCompare(b.dataset.name || '', 'sv');
          if (mode === 'name_za') return (b.dataset.name || '').localeCompare(a.dataset.name || '', 'sv');
          return 0;
        });

        cards.forEach(c => grid.appendChild(c));
      }

      if (search) search.addEventListener('input', applyFilter);
      if (sort) sort.addEventListener('change', applySort);

      // default sort
      applySort();
    })();
  </script>
</body>
</html>
